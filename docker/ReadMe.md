# В проекте (на основе модуля Command-Line-Runner) применяется Docker

### **application.yml** 
* для запуска из IDEA
### **application-docker.yml** 
* для запуска из docker-а. В **spring.datasource.url:** указано имя контейнера, что бы приложение в Docker-е смогло 
достучаться к БД. Потому что они запустятся в рамках одного docker-compose и будут знать друг о друге. Это нужно, чтобы
у нас была одна закрытая инфраструктура для проекта.

В проекте создается Image приложения. Тестирование производиться на базе PostgreSQl из контейнера, так же подключен 
контейнер [PgAdmin](http://localhost:5050/browser/) для просмотра базы данных после запуска приложения.

### Docker Compose
* это инструмент, который упрощает управление многоконтейнерными приложениями с использованием Docker. Он позволяет 
вам определить и настроить все контейнеры, сети и объемы для вашего приложения в одном файле конфигурации в формате 
YAML, а затем запустить их одной командой.

### **Dockerfile** 
* это текстовый файл, который содержит инструкции для создания Docker-образа. Образ Docker - это пакет, который 
включает в себя все необходимое для запуска контейнера, включая код, зависимости, переменные окружения и многое другое.

**Container** - текущий экземпляр, который инкапсулирует необходимое ПО. Контейнеры всегда создаются из **Image**. 
Могут открывать **Port**-ы и **Volume**-ы для взаимодействия с другими контейнерами и/или внешним миром, а также легко 
удаляются и пересоздаются заново за короткий промежуток времени.

**Image** - основной элемент для каждого **Container**. После его создания каждый шаг кэшируется и может быть 
использован повторно (модель копирования при записи). В зависимости от **Image** может понадобиться некоторое время 
для его построения. Из них могут быть сразу запущены контейнеры.

**Port** - TCP/UDP-порт в своем обычном представлении. Порты могут быть открыты для внешнего мира (доступы через 
основную ОС) или подсоединены к другим контейнерам — доступны только из тех контейнеров и невидимы для внешнего мира.

**Volume** - может быть описан как общая папка. **Volume**(тома) инициализируются при создании контейнера. 
Они спроектированы для хранения данных независимо от жизненного цикла контейнера.

**Registry** - сервер, который хранит образы Docker. Функционирует по аналогии с Github — можно вытянуть образ, чтобы 
развернуть его локально, а затем закинуть обратно в реестр. 

**[Docker Hub](https://hub.docker.com/search?q=&type=image)** - реестр с веб-интерфейсом, созданный Docker Inc. 
Он хранит большое количество Docker-образов с разным ПО. Docker Hub является источником «официальных» Docker-образов, 
созданных командой Docker. Официальные образы содержат списки своих потенциальных уязвимостей. Эта информация доступна 
для каждого авторизированного пользователя. Доступны два типа аккаунтов: бесплатные и платные. На бесплатном аккаунте 
может быть один приватный образ и бесконечное количество общедоступных образов.

## Команды Docker
### Основные команды:
1) Команда **docker pull** используется для загрузки образа с Docker Hub:
```Например:
# Эта команда загрузит образ Ubuntu версии 20.04.
docker pull ubuntu:20.04
```
2) Команда **docker run** используется для запуска контейнера из образа:
```Например:
# -it: Флаги -it обеспечивают интерактивный режим и привязку к терминалу контейнера.
docker run -it ubuntu:20.04 /bin/bash
```
3) Команда **docker ps** выводит список запущенных контейнеров. Добавление флага -a покажет все контейнеры, включая остановленные.
4) Команда **docker stop** используется для остановки контейнера:
```Например:
docker stop container_id
```
5) Команда **docker rm** удаляет контейнер:
```Например:
docker rm container_id
```
6) Команда **docker images** выводит список загруженных образов.
7) Команда **docker rmi** удаляет образ:
```Например:
docker rmi image_id
```
8) Команда **docker exec** используется для выполнения команды в запущенном контейнере:
```Например:
docker exec -it container_id /bin/bash
```
9) Команда **docker logs** выводит логи контейнера:
```Например:
docker logs container_id
```
10) Команда **docker stats** выводит статистику использования ресурсов контейнера.

### Основные флаги Docker команд:
1) Загрузка образа и создание контейнера:
**-t** - Устанавливает имя и (при желании) тег образа. 
```Например:
# задает имя "myapp" с тегом "latest".
-t myapp:latest
```
2) Запуск контейнера:
- **-d**: Запускает контейнер в фоновом режиме (демон).
- **-i**: Включает интерактивный режим (stdin) для контейнера.
- **-t**: Подключает tty (терминал) контейнера к вашему терминалу.

3) Порты и сеть:
- **-p**: Пробрасывает порты между хостом и контейнером:
```Например:
#  позволяет доступ к порту 80 контейнера через порт 8080 на хосте.
-p 8080:80
```
- **--network**: Определяет сеть, к которой присоединен контейнер:
```Например:
#  подключает контейнер к сети с именем "my_network".
--network=my_network
```

### Управление контейнерами:
- docker start: Запускает остановленный контейнер.
- docker stop: Останавливает работающий контейнер.
- docker restart: Перезапускает контейнер.
- docker pause: Приостанавливает выполнение контейнера.
- docker unpause: Возобновляет выполнение приостановленного контейнера.
- docker kill: Прерывает выполнение контейнера насильно.
- docker rm: Удаляет контейнер.
- docker rmi: Удаляет образ.

#### Удаление контейнеров и образов
    -f, --force: Принудительное удаление контейнера, даже если он запущен. Используется вместе с командой docker rm.
    -v, --volumes: Удаление контейнера вместе с его привязанными Docker-томами (volumes). Используется вместе с командой docker rm.
    -l, --link: Удаление контейнера и всех его связей с другими контейнерами. Используется вместе с командой docker rm.
    -f, --force: Принудительное удаление образа, даже если он используется контейнерами. Используется вместе с командой docker rmi.
    -q, --quiet: Вывод только идентификаторов образов без дополнительной информации. Используется вместе с командой docker rmi.

#### Флаги при запуске контейнера
    -d: Запускает контейнер в фоновом режиме (демон).
    -i: Включает интерактивный режим (stdin) для контейнера.
    -t: Подключает tty (терминал) контейнера к вашему терминалу.

Эти флаги при запуске контейнера позволяют настраивать его режим работы для конкретных задач.

### Основные команды Docker Compose
После создания файла docker-compose.yml, вы можете использовать следующие основные команды Docker Compose для управления вашим приложением:
- docker-compose up: Запускает приложение на основе файла docker-compose.yml. Если контейнеры не существуют, они будут созданы, и приложение будет запущено в фоновом режиме.
- docker-compose down: Останавливает и удаляет все контейнеры, сети и объемы, связанные с приложением, определенным в файле docker-compose.yml.
- docker-compose ps: Показывает статус всех сервисов, определенных в файле docker-compose.yml.
- docker-compose logs: Отображает логи всех сервисов в реальном времени.
- docker-compose exec <service-name> <command>: Запускает команду внутри контейнера сервиса. Например, docker-compose exec app bash запустит интерактивный shell в контейнере app.


## Структура Dockerfile
```
Dockerfile имеет следующую структуру:
# Комментарии начинаются с символа "#"
# Базовый образ
FROM base_image:tag
# Установка дополнительных пакетов
RUN apt-get update && apt-get install -y package_name
# Копирование файлов в образ
COPY source_path destination_path
# Установка переменных окружения
ENV variable_name=value
# Указание рабочей директории
WORKDIR /app
# Открытие порта
EXPOSE port_number
# Запуск команды при запуске контейнера
CMD ["command", "arg1", "arg2"]
```

### Основные команды Dockerfile
Инструкция **FROM** указывает базовый образ, на основе которого будет создаваться ваш образ. Этот образ может быть официальным образом из репозитория Docker Hub или собранным другими пользователями. 
```Пример:
FROM ubuntu:20.04
```
Инструкция **RUN** выполняет команду внутри контейнера во время создания образа. Это может использоваться для установки пакетов, обновления системы и выполнения других операций. 
```Пример:
RUN apt-get update && apt-get install -y package_name
```
Инструкция **COPY** копирует файлы из исходной директории на вашем компьютере внутрь контейнера. 
```Пример:
COPY source_path destination_path
```
Инструкция **ENV** устанавливает переменные окружения в контейнере. Это может быть использовано для настройки конфигурации приложения. 
```Пример:
ENV MY_ENV_VARIABLE=my_value
```
Инструкция **WORKDIR** устанавливает рабочую директорию для всех последующих инструкций в Dockerfile. 
```Пример:
WORKDIR /app
```
Инструкция **EXPOSE** указывает порт, который контейнер будет слушать при запуске. Однако это не пробрасывает порт на хост машину, это просто информационная метка. 
```Пример:
EXPOSE 80
```
Инструкция **CMD** задает команду, которая будет выполнена при запуске контейнера. Это может быть команда запуска вашего приложения. 
```Пример:
CMD ["command", "arg1", "arg2"]
```
### Пример полного Dockerfile для простого веб-приложения на Node.js:
```
# Используем официальный образ Node.js
FROM node:14
# Создаем рабочую директорию внутри контейнера
WORKDIR /app
# Копируем файлы package.json и package-lock.json
COPY package*.json ./
```

## Порядок запуска контейнеров
1) Запуск docker-compose из корня модуля docker (С:\Java\CarPart\docker> docker-compose up -d)
```
doker-compose up -d
```
2) Проверяем создание контейнеров
```
docker-compose ps
```
![alt-текст][logo_docker_compose_ps]
 
5) Для просмотра логов используем команду
```
docker-compose logs -f <имя SERVICE. Например PostgreSQL-Container>
```
4) Пример настройки подключения к БД:

![alt-текст][logo_PgAdmin_DB_Connection]

![alt-текст][logo_IDEA_DB_Connection]


### Ссылки для Docker-compose
* [Официальный сайт](https://docs.docker.com/)
* [Справочная информация по Dockerfile](https://docs.docker.com/engine/reference/builder/#dockerfile-reference)
* [Капитан грузового судна, или Как начать использовать Docker в своих проектах](https://tproger.ru/translations/how-to-start-using-docker)
* [Docker и Docker Compose: Полное руководство для начинающих](https://dzen.ru/a/ZSJCuZCwPUXxX3TD)
* [Overview of best practices for writing Dockerfiles](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#run)
* [Compose file](https://docs.docker.com/compose/compose-file/)
* [Overview of Docker Compose (официальный сайт)](https://docs.docker.com/compose/)
* [Варианты запуска docker-compose up](https://docs.docker.com/engine/reference/commandline/compose_up/)
* [Шпаргалка по DockerCompose](https://devops.org.ru/dockercompose-summary)
* [Полное практическое руководство по Docker: с нуля до кластера на AWS](https://habr.com/ru/articles/310460/)
* [Поняв Docker](https://habr.com/ru/articles/277699/)
* [Полная автоматизация «development» среды с помощью docker-compose](https://habr.com/ru/articles/322440/)
* [Docker-compose: идеальное рабочее окружение](https://habr.com/ru/articles/346086/)
* [Добавляем все, что связано с БД. (Часть 1) - "Java-проект от А до Я"](https://javarush.com/groups/posts/3262-java-proekt-ot-a-do-ja-dobavljaem-vse-chto-svjazano-s-bd-chastjh-1)
* [Добавляем все, что связано с БД. (Часть 2) - "Java-проект от А до Я"](https://javarush.com/groups/posts/3264-java-proekt-ot-a-do-ja-dobavljaem-vse-chto-svjazano-s-bd-chastjh-2)

### Ссылки для testcontainers
* [TESTCONTAINERS Simple example with PostgreSQL](https://www.youtube.com/watch?v=VfwP3GOridU)
* [Тестирование с помощью Testcontainers: как поднять в контейнере тестовую базу](https://sysout.ru/testirovanie-s-pomoshhyu-testcontainers-ili-kak-podnyat-v-kontejnere-testovuyu-bazu/)

[logo_PgAdmin_DB_Connection]: E:\Education\Programming\Java\CarPart\docker\image\db.connection\pgadmin.png "Через PgAdmin (в браузере)"
[logo_IDEA_DB_Connection]: E:\Education\Programming\Java\CarPart\docker\image\db.connection\idea.png "Через IDEA"
[logo_docker_compose_ps]: E:\Education\Programming\Java\CarPart\docker\image\docker-compose\ps.png "Результат работы команды docker-compose ps"